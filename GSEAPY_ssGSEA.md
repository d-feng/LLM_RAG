# GSEAPY Documentation

## Overview
This guide covers Single Sample GSEA (ssGSEA), GSVA, and Replot functionality in GSEAPY.

---

## 1. Single Sample GSEA (ssGSEA)

### What is ssGSEA?
Single Sample Gene Set Enrichment Analysis calculates enrichment scores for gene sets across individual samples rather than comparing between sample groups.

### FAQ: Which One Should I Use? Prerank or ssGSEA?

#### Q1: ssGSEA missing p-value and FDR?

**A:** The original ssGSEA algorithm does not provide p-values or FDR (False Discovery Rate). Therefore:
- **Ignore the gseaplot generated by `ssgsea`** - it's useless and misleading
- P-values and FDR are not shown on the plot by design

If you need ssGSEA with p-value output, see: **https://github.com/broadinstitute/ssGSEA2.0**

> **Note**: ssGSEA2.0 uses the same method as GSEApy to calculate p-values, but the FDR calculation differs.

#### Q2: What's the difference between ssGSEA and Prerank?

**In short:**

| Method | Use Case | Description |
|--------|----------|-------------|
| **Prerank** | Comparing two groups | Used for comparing two groups of samples (e.g., control vs. treatment), where gene ranking is defined by your custom rank method (t-statistic, signal-to-noise, etc.) |
| **ssGSEA** | Individual sample analysis | Used for comparing individual samples to the rest, trying to find gene signatures that samples share (use when you have many samples) |

**Statistical Differences:**

The enrichment score (ES) calculation differs between the two methods. After calculating the running enrichment scores for ranked input genes:

- **ES for GSEA/Prerank**: `max(running enrichment scores)` or `min(running enrichment scores)`
- **ES for ssGSEA**: `sum(running enrichment scores)`

This fundamental difference in how ES is calculated affects the interpretation and use case for each method

### Input Data Formats

**Supported data types:**
- Text file (`.txt`)
- GCT file (`.gct`)
- `pd.DataFrame`
- `pd.Series` (with gene names as index)

**Supported gene set formats:**
```python
# Single library from Enrichr
gene_sets="KEGG_2016"

# Multiple libraries
gene_sets="KEGG_2016,KEGG2013"

# GMT file
gene_sets="./data/genes.gmt"

# Multiple sources
gene_sets=["KEGG_2016", "./data/genes.gmt"]

# Dictionary
gene_sets={
    'A': ['gene1', 'gene2', ...],
    'B': ['gene2', 'gene4', ...],
    ...
}
```

> **Important**: Gene symbols in Enrichr libraries are all **UPPERCASE**. Convert your input gene identifiers to uppercase first. For identifier conversion, refer to section 1.2: Mouse gene symbols maps to Human, or Vice Versa.

### Basic Usage

#### File Input Example
```python
import gseapy as gp

# Using text/GCT file input
ss = gp.ssgsea(
    data='./tests/extdata/Leukemia_hgu95av2.trim.txt',
    gene_sets='./tests/extdata/h.all.v7.0.symbols.gmt',
    outdir=None,
    sample_norm_method='rank',  # 'custom' uses raw values only
    no_plot=True
)
```

**Output:**
```
2025-02-04 15:48:18,961 [WARNING] Found duplicated gene names, values averaged by gene names!
```

#### DataFrame/Series Input Example
```python
# Load data as DataFrame
ssdf = pd.read_csv("./tests/data/temp.rnk", header=None, index_col=0, sep="\t")

# Convert to Series (gene names must be index)
ssdf2 = ssdf.squeeze()

# Run ssGSEA with DataFrame or Series
temp = gp.ssgsea(
    data=ssdf2,
    gene_sets="./tests/data/temp.gmt"
)
```

### Accessing Results

#### Enrichment Scores (ES) and Normalized Enrichment Scores (NES)

Results are stored in `obj.res2d`:

```python
# View top results
ss.res2d.head()
```

| Name | Term | ES | NES |
|------|------|-----|-----|
| ALL_2 | HALLMARK_MYC_TARGETS_V1 | 3393.824 | 0.708 |
| ALL_12 | HALLMARK_MYC_TARGETS_V1 | 3385.626 | 0.706 |
| AML_11 | HALLMARK_MYC_TARGETS_V1 | 3359.187 | 0.701 |

#### Pivoting Results

```python
# Sort by sample name
ss.res2d.sort_values('Name').head()

# Create pivot table with NES values
nes = ss.res2d.pivot(index='Term', columns='Name', values='NES')
nes.head()
```

This creates a matrix with gene sets (Terms) as rows and samples as columns.

### Advanced Options

> **⚠️ WARNING**: Setting `permutation_num > 0` makes ssGSEA behave like Prerank with ssGSEA statistics. **DO NOT use this unless you know what you are doing!**

```python
ss_permut = gp.ssgsea(
    data="./tests/extdata/Leukemia_hgu95av2.trim.txt",
    gene_sets="./tests/extdata/h.all.v7.0.symbols.gmt",
    outdir=None,
    sample_norm_method='rank',
    permutation_num=20,  # Enables permutation testing
    no_plot=True,
    processes=4,
    seed=9
)
```

### Command Line Usage

```bash
gseapy ssgsea -d ./data/testSet_rand1200.gct \
              -g data/temp.gmt \
              -o test/ssgsea_report2 \
              -p 4 --no-plot
```

---

## 2. GSVA (Gene Set Variation Analysis)

GSVA is another single-sample enrichment method that calculates enrichment scores differently from ssGSEA.

### Basic Usage

```python
import gseapy as gp

# Run GSVA
es = gp.gsva(
    data='./tests/extdata/Leukemia_hgu95av2.trim.txt',
    gene_sets='./tests/extdata/h.all.v7.0.symbols.gmt',
    outdir=None
)
```

### Accessing Results

```python
# Pivot results to create ES matrix
es.res2d.pivot(index='Term', columns='Name', values='ES').head()
```

Results show enrichment scores for each gene set across all samples, with values typically ranging from -1 to 1.

### Command Line Usage

```bash
gseapy ssgsea -d ./tests/data/expr.gsva.csv \
              -g ./tests/data/geneset.gsva.gmt \
              -o test/gsva_report
```

---

## 3. Replot Module

The replot module allows you to regenerate plots from previous GSEA analyses.

### Directory Structure Requirements

The replot module requires an `edb` folder with the following structure:

```
data/
 |--- edb/
 |    |--- C1OE.cls
 |    |--- gene_sets.gmt
 |    |--- gsea_data.gsea_data.rnk
 |    |--- results.edb
```

### Python Usage

```python
# Run replot within Python console
rep = gp.replot(
    indir="./tests/data",
    outdir="tests/replot_test"
)
```

### Command Line Usage

```bash
gseapy replot -i data -o test/replot_test
```

---

## Key Parameters Reference

### ssGSEA / GSVA Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `data` | Input expression data (file path, DataFrame, or Series) | Required |
| `gene_sets` | Gene sets (library name, GMT file, or dictionary) | Required |
| `outdir` | Output directory (None = no file output) | None |
| `sample_norm_method` | Normalization method ('rank' or 'custom') | 'rank' |
| `no_plot` | Skip plot generation | False |
| `permutation_num` | Number of permutations (ssGSEA only) | 0 |
| `processes` | Number of parallel processes | 1 |
| `seed` | Random seed for reproducibility | None |

---

## Tips and Best Practices

1. **Gene Identifier Formatting**: Always convert gene symbols to uppercase when using Enrichr libraries
2. **Duplicate Genes**: GSEAPY automatically averages values for duplicate gene names
3. **Data Format**: Use gene names/symbols as the index for Series or DataFrame inputs
4. **Performance**: Use `processes` parameter for parallel processing with large datasets
5. **Visualization**: Set `no_plot=True` if you only need the numerical results
6. **Reproducibility**: Set `seed` parameter for reproducible results when using permutations