# CellTypist PBMC Labeling Tutorial

To demonstrate how to label your own data using our model, we'll label a PBMC dataset previously published in Swanson, et al. (2022) and available at GEO Accession GSM5513397.

This demonstration is written in Python, as CellTypist is available as a Python module. We also utilize the Scanpy package for single-cell data analysis, described in Wolf, et al. (2018).

## Install Packages

```bash
!pip install -q scanpy
!pip install -q celltypist
!pip install -q session_info
```

## Load Modules

```python
from urllib.request import urlretrieve

import celltypist
import scanpy as sc
```

## Specify CellTypist models

In addition to our own CellTypist models, we'll use a Healthy PBMC model provided from the CellTypist model collection:

```python
celltypist.models.download_models(
    force_update = True,
    model = ['Healthy_COVID19_PBMC.pkl']
)
```

Here, we specify the path to the CellTypist models. For this demo, we assume the AIFI CellTypist models have been downloaded from the Downloads Page, and are placed in the working directory.

```python
model_files = {
    'CellTypist_PBMC': 'Healthy_COVID19_PBMC.pkl',
    'AIFI_L1': 'ref_pbmc_clean_celltypist_model_AIFI_L1_2024-04-18.pkl',
    'AIFI_L2': 'ref_pbmc_clean_celltypist_model_AIFI_L2_2024-04-19.pkl',
    'AIFI_L3': 'ref_pbmc_clean_celltypist_model_AIFI_L3_2024-04-19.pkl'
}
```

## Download dataset from GEO

Next, we'll download the dataset we want to label from GEO. This .h5 file is provided as a Supplementary File in the GEO entry for GSM5513397

```python
geo_url = "https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSM5513397&format=file&file=GSM5513397%5FW4%2Dhashed%2D24k%5Fcount%2Dmatrix%2Eh5"
h5_filename = "GSM5513397_W4-hashed-24k_count-matrix.h5"
urlretrieve(geo_url, h5_filename)
```

## Load and normalize data with Scanpy

Next, we'll load the dataset using Scanpy, and normalize and log transform the data to meet the requirements of the CellTypist module for labeling.

```python
adata = sc.read_10x_h5(h5_filename)
adata
```

Output:
```
AnnData object with n_obs × n_vars = 14478 × 36601
      var: 'gene_ids', 'feature_types', 'genome'
```

```python
sc.pp.normalize_total(adata, target_sum = 1e4)
sc.pp.log1p(adata)
```

## Predict labels with each model

Now, we can loop through each model specified above and label the cells using CellTypist.

CellTypist provides multiple kinds of results about these labels. For this demo, we'll keep just the highest scoring label and the corresponding labeling score generated by CellTypist.

```python
label_results = {}

for model_name, model in model_files.items():
    label_column = f'{model_name}_prediction'
    score_column = f'{model_name}_score'
    
    predictions = celltypist.annotate(
        adata, 
        model = model
    )
    
    labels = predictions.predicted_labels
    labels = labels.rename({'predicted_labels': label_column}, axis = 1)

    prob = predictions.probability_matrix
    prob_scores = []
    for i in range(labels.shape[0]):
        prob_scores.append(prob.loc[labels.index.to_list()[i],labels[label_column][i]])
    labels[score_column] = prob_scores

    label_results[model_name] = labels
```

## Preview results for each model

After generating label predictions, let's look at the top 10 labels assigned by each of the labeling models:

```python
for model_name, label_df in label_results.items():    
    label_column = f'{model_name}_prediction'
    label_summary = label_df[label_column].value_counts()
    print(label_summary[0:10], end = '\n\n')
```

## Add labels to the dataset

In order to use the labels for visualization, as well as any downstream analyses we might want to do, we'll add the labels and scores from our celltypist labels to the AnnData object.

```python
for model_name, label_df in label_results.items():    
    label_column = f'{model_name}_prediction'
    score_column = f'{model_name}_score'

    adata.obs[label_column] = label_df[label_column]
    adata.obs[score_column] = label_df[score_column]
```

## Dimensionality reduction for visualization

Next, we can perform dimensionality reduction with PCA and 2-dimensional projection with UMAP to allow us to visualize the labels on the data.

```python
sc.pp.highly_variable_genes(adata)
sc.tl.pca(adata)
sc.pp.neighbors(adata, n_pcs = 30)
sc.tl.umap(adata)
```

## Optional: Add colorsets for visualization

If you want to match the colors used in our publications, you can do so by reading the colorset tables we provide on our Downloads page.

```python
color_files = {
    'AIFI_L1': 'AIFI_L1_imm_health_atlas_type_order_colors.csv',
    'AIFI_L2': 'AIFI_L2_imm_health_atlas_type_order_colors.csv',
    'AIFI_L3': 'AIFI_L3_imm_health_atlas_type_order_colors.csv'
}
```

### Generate dictionaries for matching colors to categorical value order

```python
color_dicts = {}
for level, file in color_files.items():
    color_df = pd.read_csv(file)
    color_dict = {}
    for i in range(color_df.shape[0]):
        cell_type = color_df[level].loc[i]
        type_color = color_df[f'{level}_color'].loc[i]
        color_dict[cell_type] = type_color
    color_dicts[level] = color_dict
```

### Assign colors to the AnnData object

```python
for level, color_dict in color_dicts.items():
    color_order = adata.obs[f'{level}_prediction'].cat.categories
    level_colors = [color_dict[x] for x in color_order]
    adata.uns[f'{level}_prediction_colors'] = level_colors
```

## Plot labels on UMAP projections

Finally, let's plot the labeling scores and cell type labels from each CellTypist model.

**Note:** Due to the use of a multinomial regression for training of the AIFI_L3 model, the AIFI_L3_score values are higher than those for the other models.

```python
for model_name in label_results.keys():    
    label_column = f'{model_name}_prediction'
    score_column = f'{model_name}_score'
    
    sc.pl.umap(
        adata,
        color = [score_column, label_column]
    )
```